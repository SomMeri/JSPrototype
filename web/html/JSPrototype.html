<!DOCTYPE HTML>
<html lang="en">
<head>
<title>JSPrototype</title>
<meta charset="utf-8">
<style type="text/css">
body {
	font-family: Monospace;
	font-size: 12px;
	background-color: #f0f0f0;
	margin: 0px;
	overflow: hidden;
}

#upperrow {
	position: absolute;
	top: 5px;
	width: 100%;
}

.gameoptions {
	color: #444; 
	background-color: #fff; 
	border-bottom: 1px solid #ddd; 
	padding: 8px 10px; 
	text-align: left;
}

.leveloptions {
	color: #444; 
	background-color: #fff; 
	border-bottom: 1px solid #ddd; 
	padding: 8px 10px; 
	text-align: right;
}

</style>
</head>
<body>
	<!--  
	<script type="text/javascript" src="../js/ThreeCanvas.js"></script>
	<script type="text/javascript" src="../js/ExtrudeGeometry.js"></script>
	<script type="text/javascript" src="../js/TextGeometry.js"></script>
	<script type="text/javascript" src="../js/Curve.js"></script>
	<script type="text/javascript" src="../js/CurvePath.js"></script>
	<script type="text/javascript" src="../js/Path.js"></script>
	<script type="text/javascript" src="../js/TextPath.js"></script>
	<script type="text/javascript" src="../js/Text.js"></script>-->

	<script type="text/javascript" src="../js/Three.js"></script>
	
	<script type="text/javascript" src="../js/helvetiker_regular.typeface.js"></script>
	
	<script type="text/javascript" src="../js/OrientationText.js"></script>
	<script type="text/javascript" src="../js/Cube.js"></script>
	<script type="text/javascript" src="../js/Robot.js"></script>
	<script type="text/javascript" src="../js/Plane.js"></script>
	<script type="text/javascript" src="../js/LevelsLibrary.js"></script>
	<script type="text/javascript" src="../js/LevelInitializer.js"></script>
	<script type="text/javascript" src="../js/GameEngine.js"></script>
	<script type="text/javascript" src="../js/GraphicEngine.js"></script>

	<div id="container">
	<div id="upperrow">
		<span class="gameoptions" > 
			<strong>DRAG</strong>: ROTATE | <strong>SELECT LEVEL</strong>: <select onChange="changeLevel(this)" name="chooseLevel" id="chooseLevel"></select> | <a href="javascript:clear();">RESET LEVEL</a>
		</span>
		<span> &nbsp; </span>
		<span class="leveloptions" > 
			<strong>STEPS</strong>: <span id="stepsnum">0</span> | <a href="javascript:undo();">UNDO</a>
		</span>
	</div>
	</div>
	<script type="text/javascript">
		var levelChooser = document.getElementById("chooseLevel");
		var library = new LevelsLibrary();
		
	  	for(var level = 0; level < library.names.length; level++) {
	  	  var option = document.createElement("option");
	      option.text = library.names[level];
	      option.value = level;
	      try {
	        levelChooser.add(option, null); //Standard
	      }catch(error) {
	        levelChooser.add(option); // IE only
	      }
	  	}
	</script>
	
	<script type="text/javascript">

			var container, interval,
			renderer,
			plane, cube, linesMaterial,
			color = 0, colors = [ 0xDF1F1F, 0xDFAF1F, 0x80DF1F, 0x1FDF50, 0x1FDFDF, 0x1F4FDF, 0x7F1FDF, 0xDF1FAF, 0xEFEFEF, 0x303030 ],
			isMouseDown = false, onMouseDownPosition,
			radious = 1600, theta = 45, onMouseDownTheta = 45, phi = 60, onMouseDownPhi = 60;
			
			var library = new LevelsLibrary();
			var graphicEngine;
			var gameEngine;

			init();

			function init() {
			  //lets be courageous
			  Object.prototype.clone = function() {
			    var newObj = (this instanceof Array) ? [] : {};
			    for (i in this) {
			      if (i == 'clone') continue;
			      if (this[i] && typeof this[i] == "object") {
			        newObj[i] = this[i].clone();
			      } else newObj[i] = this[i]
			    } return newObj;
			  };
			  
			  container = document.getElementById("container");
				
				var smallestLevel = new Level('  #####  ',
				                      ' #    .# ',
				                      ' #  @$ # ',
				                      ' #     # ',
		        		              '#    $. #',
				                      ' ####### ');
				
				

				
				graphicEngine = new GraphicEngine();
				gameEngine = new GameEngine(graphicEngine, smallestLevel, refreshStats);
				renderer = graphicEngine.getRenderer();

				onMouseDownPosition = new THREE.Vector2();
				container.appendChild(renderer.domElement);
				
				initEventListeners();

				var levelChooser = document.getElementById("chooseLevel");
	  			levelChooser.selectedIndex = 0;
	  			changeLevel(levelChooser);
			}

			function refreshStats() {
			  if (!(typeof gameEngine === 'undefined')) {
				  var html = document.getElementById("stepsnum");
				  html.innerHTML = gameEngine.stepsSoFar();
			  }
			}

			function initEventListeners() {
				document.addEventListener( 'keydown', onDocumentKeyDown, false );
				document.addEventListener( 'keyup', onDocumentKeyUp, false );

				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				document.addEventListener( 'mouseup', onDocumentMouseUp, false );
			}
			
			function onDocumentKeyDown( event ) {

				switch( event.keyCode ) {
					case 37: gameEngine.moveLeft(); break;
					case 38: gameEngine.moveUp(); break;
					case 39: gameEngine.moveRight(); break;
					case 40: gameEngine.moveDown(); break;
				 }
			}

			function onDocumentKeyUp( event ) {
			}

			function onDocumentMouseDown( event ) {

				event.preventDefault();

				isMouseDown = true;

				onMouseDownTheta = theta;
				onMouseDownPhi = phi;
				onMouseDownPosition.x = event.clientX;
				onMouseDownPosition.y = event.clientY;
			}

			function onDocumentMouseMove( event ) {

				event.preventDefault();

				if ( isMouseDown ) {

					theta = - ( ( event.clientX - onMouseDownPosition.x ) * 0.5 ) + onMouseDownTheta;
					phi = ( ( event.clientY - onMouseDownPosition.y ) * 0.5 ) + onMouseDownPhi;

					phi = Math.min( 180, Math.max( 0, phi ) );
					graphicEngine.rotateView(theta, phi);
				}

				graphicEngine.render();

			}

			function onDocumentMouseUp( event ) {

				event.preventDefault();

				isMouseDown = false;

				onMouseDownPosition.x = event.clientX - onMouseDownPosition.x;
				onMouseDownPosition.y = event.clientY - onMouseDownPosition.y;

				if ( onMouseDownPosition.length() > 5 ) {

					return;

				}
				graphicEngine.render();
			}
	  	
	  		function changeLevel(levelChooser) {
	  		  var levelId = levelChooser.options[levelChooser.selectedIndex].value;
	  		  gameEngine.resetLevel(library.levels[levelId]);
	  		}

			function clear() {
				if ( !confirm( 'Are you sure?' ) ) {
					return ;
				}
				gameEngine.resetLevel();
				graphicEngine.render();
			}

			function undo() {
				gameEngine.undoMove();
				graphicEngine.render();
			}

		</script>

</body>
</html>
